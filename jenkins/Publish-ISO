pipeline {
  agent {
    node {
      label 'SCALE-Build'
    }
  }
  parameters {
    booleanParam(
      name: 'SKIP_BUILD_UPLOAD',
      defaultValue: false,
      description: 'Skip uploading build artifacts (ISO, update files) - useful when only updating releases.json'
    )
  }
  stages {
    stage('Upload') {
      when {
        expression { !params.SKIP_BUILD_UPLOAD }
      }
      steps {
        echo '*** Grabbing artifacts from Build - TrueNAS SCALE (Full - Nightly ISO) ***'
        copyArtifacts filter: '**/*.iso', fingerprintArtifacts: true, flatten: true, projectName: 'Build - TrueNAS SCALE (Full - Nightly ISO)', selector: lastSuccessful(), target: 'upload/files'
        copyArtifacts filter: '**/*.sha256', fingerprintArtifacts: true, flatten: true, projectName: 'Build - TrueNAS SCALE (Full - Nightly ISO)', selector: lastSuccessful(), target: 'upload/files'
        sh 'ssh jenkins@staging.sys.ixsystems.net mkdir -p /zdata/download.sys.truenas.net/truenas-scale-goldeye-nightly/ || true'
        sh 'scp upload/files/TrueNAS-SCALE*.iso upload/files/TrueNAS-SCALE*.iso.sha256 jenkins@staging.sys.ixsystems.net:/zdata/download.sys.truenas.net/truenas-scale-goldeye-nightly/'
        sh 'rm -rf upload/files'
        copyArtifacts filter: '**/*.update', fingerprintArtifacts: true, flatten: true, projectName: 'Build - TrueNAS SCALE (Full - Nightly ISO)', selector: lastSuccessful(), target: 'upload/files'
        copyArtifacts filter: '**/*.json', fingerprintArtifacts: true, flatten: true, projectName: 'Build - TrueNAS SCALE (Full - Nightly ISO)', selector: lastSuccessful(), target: 'upload/files'
        sh 'ssh jenkins@staging.sys.ixsystems.net mkdir -p /zdata/update.sys.truenas.net/scale/TrueNAS-SCALE-Goldeye-Nightlies || true'
        sh 'scp upload/files/manifest.json upload/files/TrueNAS-SCALE-*.update jenkins@staging.sys.ixsystems.net:/zdata/update.sys.truenas.net/scale/TrueNAS-SCALE-Goldeye-Nightlies/'
      }
    }
    stage('Update Releases JSON') {
      steps {
        script {
          // If we skipped upload, we need to get the manifest.json from the build
          if (params.SKIP_BUILD_UPLOAD) {
            sh 'mkdir -p upload/files'
            copyArtifacts filter: '**/manifest.json', fingerprintArtifacts: true, flatten: true, projectName: 'Build - TrueNAS SCALE (Full - Nightly ISO)', selector: lastSuccessful(), target: 'upload/files'
          }
          
          // Download existing releases.json if it exists
          sh '''scp jenkins@staging.sys.ixsystems.net:/zdata/update.sys.truenas.net/scale/TrueNAS-SCALE-Goldeye-Nightlies/releases.json upload/files/releases.json || echo "{}" > upload/files/releases.json'''
          
          // Read manifest.json and extract information
          def manifestContent = readFile('upload/files/manifest.json')
          def manifest = readJSON text: manifestContent
          
          // Read existing releases.json
          def existingReleasesContent = readFile('upload/files/releases.json')
          def existingReleases = readJSON text: existingReleasesContent
          
          // Add new release entry to existing releases dictionary
          // Copy all manifest fields and add profile
          def releaseEntry = [:]
          manifest.each { key, value ->
            releaseEntry[key] = value
          }
          releaseEntry.profile = 'DEVELOPER'
          existingReleases[manifest.version] = releaseEntry
          
          // Keep only the last 30 entries by date
          if (existingReleases.size() > 30) {
            // Convert to list of entries for sorting
            def entries = []
            existingReleases.each { key, value ->
              entries.add([key: key, value: value, date: value.date])
            }
            
            // Sort by date using Collections.sort (CPS-safe)
            Collections.sort(entries, new Comparator() {
              int compare(a, b) {
                // Reverse order - newest first
                return b.date.compareTo(a.date)
              }
            })
            
            // Keep only the most recent 30 entries using subList
            def recentEntries = entries.size() > 30 ? entries.subList(0, 30) : entries
            
            // Rebuild the map
            existingReleases = [:]
            recentEntries.each { entry ->
              existingReleases[entry.key] = entry.value
            }
          }
          
          // Write updated releases.json
          writeJSON file: 'upload/files/releases.json', json: existingReleases, pretty: 4
          
          // Upload updated releases.json
          sh '''scp upload/files/releases.json jenkins@staging.sys.ixsystems.net:/zdata/update.sys.truenas.net/scale/TrueNAS-SCALE-Goldeye-Nightlies/'''
          sh 'rm -rf upload/files'
        }
      }
    }
  }
}