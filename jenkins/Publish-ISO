pipeline {
  agent {
    node {
      label 'SCALE-Build'
    }
  }
  parameters {
    booleanParam(
      name: 'SKIP_BUILD_UPLOAD',
      defaultValue: false,
      description: 'Skip uploading build artifacts (ISO, update files) - useful when only updating releases.json'
    )
  }
  stages {
    stage('Upload') {
      when {
        expression { !params.SKIP_BUILD_UPLOAD }
      }
      steps {
        echo '*** Grabbing artifacts from Build - TrueNAS SCALE (Full - Nightly ISO) ***'
        copyArtifacts filter: '**/*.iso', fingerprintArtifacts: true, flatten: true, projectName: 'Build - TrueNAS SCALE (Full - Nightly ISO)', selector: lastSuccessful(), target: 'upload/files'
        copyArtifacts filter: '**/*.sha256', fingerprintArtifacts: true, flatten: true, projectName: 'Build - TrueNAS SCALE (Full - Nightly ISO)', selector: lastSuccessful(), target: 'upload/files'
        sh 'ssh jenkins@staging.sys.ixsystems.net mkdir -p /zdata/download.sys.truenas.net/truenas-scale-goldeye-nightly/ || true'
        sh 'scp upload/files/TrueNAS-SCALE*.iso upload/files/TrueNAS-SCALE*.iso.sha256 jenkins@staging.sys.ixsystems.net:/zdata/download.sys.truenas.net/truenas-scale-goldeye-nightly/'
        sh 'rm -rf upload/files'
        copyArtifacts filter: '**/*.update', fingerprintArtifacts: true, flatten: true, projectName: 'Build - TrueNAS SCALE (Full - Nightly ISO)', selector: lastSuccessful(), target: 'upload/files'
        copyArtifacts filter: '**/*.json', fingerprintArtifacts: true, flatten: true, projectName: 'Build - TrueNAS SCALE (Full - Nightly ISO)', selector: lastSuccessful(), target: 'upload/files'
        sh 'ssh jenkins@staging.sys.ixsystems.net mkdir -p /zdata/update.sys.truenas.net/scale/TrueNAS-SCALE-Goldeye-Nightlies || true'
        sh 'scp upload/files/manifest.json upload/files/TrueNAS-SCALE-*.update jenkins@staging.sys.ixsystems.net:/zdata/update.sys.truenas.net/scale/TrueNAS-SCALE-Goldeye-Nightlies/'
      }
    }
    stage('Update Releases JSON') {
      steps {
        script {
          // If we skipped upload, we need to get the manifest.json from the build
          if (params.SKIP_BUILD_UPLOAD) {
            sh 'mkdir -p upload/files'
            copyArtifacts filter: '**/manifest.json', fingerprintArtifacts: true, flatten: true, projectName: 'Build - TrueNAS SCALE (Full - Nightly ISO)', selector: lastSuccessful(), target: 'upload/files'
          }
          
          // Download existing releases.json if it exists
          sh '''scp jenkins@staging.sys.ixsystems.net:/zdata/update.sys.truenas.net/scale/TrueNAS-SCALE-Goldeye-Nightlies/releases.json upload/files/releases.json || echo "{}" > upload/files/releases.json'''
          
          // Read manifest.json and extract information
          def manifestContent = readFile('upload/files/manifest.json')
          def manifest = readJSON text: manifestContent
          
          // Read existing releases.json
          def existingReleasesContent = readFile('upload/files/releases.json')
          def existingReleases = readJSON text: existingReleasesContent
          
          // Add new release entry to existing releases dictionary
          // Copy all manifest fields and add profile
          def releaseEntry = [:]
          manifest.each { key, value ->
            releaseEntry[key] = value
          }
          releaseEntry.profile = 'DEVELOPER'
          existingReleases[manifest.version] = releaseEntry
          
          // Keep only the last 30 entries by date
          if (existingReleases.size() > 30) {
            // Convert map to list of entries with dates
            def entriesList = []
            existingReleases.each { version, data ->
              entriesList.add([version: version, data: data, dateStr: data.date])
            }
            
            // Manual bubble sort (Jenkins-safe, no closures or comparators)
            for (int i = 0; i < entriesList.size() - 1; i++) {
              for (int j = 0; j < entriesList.size() - i - 1; j++) {
                // Compare dates as strings (ISO 8601 format is lexicographically sortable)
                if (entriesList[j].dateStr < entriesList[j + 1].dateStr) {
                  // Swap entries
                  def temp = entriesList[j]
                  entriesList[j] = entriesList[j + 1]
                  entriesList[j + 1] = temp
                }
              }
            }
            
            // Keep only the first 30 entries
            def maxEntries = Math.min(30, entriesList.size())
            def recentEntries = entriesList[0..(maxEntries - 1)]
            
            // Rebuild the releases map
            existingReleases = [:]
            recentEntries.each { entry ->
              existingReleases[entry.version] = entry.data
            }
          }
          
          // Write updated releases.json
          writeJSON file: 'upload/files/releases.json', json: existingReleases, pretty: 4
          
          // Upload updated releases.json
          sh '''scp upload/files/releases.json jenkins@staging.sys.ixsystems.net:/zdata/update.sys.truenas.net/scale/TrueNAS-SCALE-Goldeye-Nightlies/'''
          sh 'rm -rf upload/files'
        }
      }
    }
  }
}